<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KBS ì£¼ì°¨ í˜„í™© ëŒ€ì‹œë³´ë“œ</title>
    <style>
        :root { --primary: #0067bc; --bg: #f4f4f9; } /* KBS ë¸”ë£¨ ì»¬ëŸ¬ ì ìš© */
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; background: var(--bg); display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); width: 100%; max-width: 420px; }
        h1 { text-align: center; color: #333; margin-bottom: 0.5rem; font-size: 1.6rem; font-weight: 800; }
        .subtitle { text-align: center; color: #666; font-size: 0.9rem; margin-bottom: 1.5rem; }
        
        .card { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px; padding: 15px; margin-bottom: 15px; }
        .form-group { margin-bottom: 10px; }
        label { display: block; margin-bottom: 5px; font-weight: 600; color: #444; font-size: 0.9rem; }
        input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 1rem; transition: 0.2s; }
        input:focus { border-color: var(--primary); outline: none; }
        
        .btn { width: 100%; padding: 14px; border: none; border-radius: 8px; font-size: 1rem; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        .btn-primary { background-color: var(--primary); color: white; box-shadow: 0 2px 4px rgba(0,103,188,0.3); }
        .btn-primary:hover { background-color: #005091; transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }
        
        .status-msg { text-align: center; margin-top: 10px; font-size: 0.9rem; min-height: 20px; }
        .status-loading { color: #e67e22; }
        .status-error { color: #e74c3c; }
        .status-success { color: #27ae60; }

        .result-box { margin-top: 20px; border-top: 2px dashed #eee; padding-top: 20px; display: none; }
        .result-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .result-label { color: #555; }
        .result-value { font-weight: 800; font-size: 1.1rem; color: #333; }
        .highlight { color: var(--primary); font-size: 1.3rem; }
        .warning { color: #e74c3c; }
        
        .info-text { font-size: 0.8rem; color: #888; text-align: center; margin-top: 20px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸš— ì£¼ì°¨ í˜„í™© ëŒ€ì‹œë³´ë“œ</h1>
    <p class="subtitle">ì‚¬ë²ˆê³¼ ë‚ ì§œë¡œ ìë™ ì¡°íšŒ</p>

    <div class="card">
        <div class="form-group">
            <label for="empNo">ì‚¬ë²ˆ (Employee No)</label>
            <input type="number" id="empNo" value="31633">
        </div>
        <button class="btn btn-primary" onclick="fetchAndCalculate()" id="actionBtn">
            ë°ì´í„° ê°€ì ¸ì˜¤ê¸° & ë¶„ì„
        </button>
        <div id="statusMsg" class="status-msg"></div>
    </div>

    <div class="result-box" id="resultBox">
        <div class="result-row">
            <span class="result-label">ì´ë²ˆ ë‹¬ ì‚¬ìš© ì‹œê°„</span>
            <span class="result-value" id="usedTime">0ë¶„</span>
        </div>
        <div class="result-row">
            <span class="result-label">ë‚¨ì€ ì‹œê°„</span>
            <span class="result-value highlight" id="remainTime">0ë¶„</span>
        </div>
        <div class="result-row">
            <span class="result-label">í’€íƒ€ì„(9h) ê°€ëŠ¥ íšŸìˆ˜</span>
            <span class="result-value" id="remainDays">0íšŒ</span>
        </div>
    </div>
    
    <div class="info-text">
        * ë³´ì•ˆ ì •ì±…ìƒ ì¤‘ê³„ ì„œë²„(AllOrigins)ë¥¼ ê²½ìœ í•©ë‹ˆë‹¤.<br>
        * íšŒì‚¬ ë‚´ë¶€ë§ ì„¤ì •ì— ë”°ë¼ ì ‘ì†ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
    </div>
</div>

<script>
    const MAX_MINUTES = 5400; // ì›” ìµœëŒ€ 5400ë¶„
    const DAILY_MAX = 540;    // ì¼ ìµœëŒ€ 540ë¶„

    function getYYYYMM() {
        const date = new Date();
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        return `${year}${month}`;
    }

    async function fetchAndCalculate() {
        const empNo = document.getElementById('empNo').value;
        const dateParam = getYYYYMM();
        const targetUrl = `http://220.73.4.2:8080/view/kbs/regular/ess?empNo=${empNo}&date=${dateParam}`;
        
        // 1. UI ìƒíƒœ ë³€ê²½
        const btn = document.getElementById('actionBtn');
        const status = document.getElementById('statusMsg');
        btn.disabled = true;
        btn.innerText = "ë°ì´í„° ì¡°íšŒ ì¤‘...";
        status.innerText = "íšŒì‚¬ ì„œë²„ì— ì ‘ì†ì„ ì‹œë„í•˜ê³  ìˆìŠµë‹ˆë‹¤...";
        status.className = "status-msg status-loading";
        document.getElementById('resultBox').style.display = 'none';

        try {
            // 2. Proxyë¥¼ í†µí•´ ë°ì´í„° ìš”ì²­ (ë³´ì•ˆ ìš°íšŒ)
            const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(targetUrl)}`;
            const response = await fetch(proxyUrl);
            const data = await response.json();

            if (!data.contents) throw new Error("ë°ì´í„°ë¥¼ ë°›ì•„ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");

            // 3. ë°ì´í„° íŒŒì‹± (HTMLì—ì„œ ì£¼ì°¨ ì‹œê°„ ì°¾ê¸°)
            // ì£¼ì˜: ì‹¤ì œ HTML êµ¬ì¡°ë¥¼ ëª¨ë¥´ë¯€ë¡œ, 'ìˆ«ì + ë¶„' íŒ¨í„´ì´ë‚˜ íŠ¹ì • í‚¤ì›Œë“œ ì£¼ë³€ ìˆ«ìë¥¼ ì°¾ìŠµë‹ˆë‹¤.
            // ë§Œì•½ ì‘ë™í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë˜ parsingLogicì„ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
            const parser = new DOMParser();
            const doc = parser.parseFromString(data.contents, "text/html");
            
            // ì‹œë„ 1: body í…ìŠ¤íŠ¸ ì „ì²´ì—ì„œ ìˆ«ì ì¶”ì¶œ (ì„ì‹œ ë¡œì§)
            // ì •í™•ë„ë¥¼ ë†’ì´ë ¤ë©´ íšŒì‚¬ ì‚¬ì´íŠ¸ HTMLì˜ íŠ¹ì • IDë‚˜ Classë¥¼ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤.
            // í˜„ì¬ëŠ” í˜ì´ì§€ ë‚´ì˜ í…ìŠ¤íŠ¸ ì¤‘ "ì´ ì£¼ì°¨ì‹œê°„" ë“±ì˜ í‚¤ì›Œë“œ ì˜†ì— ìˆëŠ” ìˆ«ìë¥¼ ì°¾ëŠ”ë‹¤ê³  ê°€ì •í•˜ê±°ë‚˜
            // ë‹¨ìˆœíˆ í˜ì´ì§€ì— ìˆëŠ” í° ìˆ«ìë¥¼ ì°¾ì•„ì•¼ í•©ë‹ˆë‹¤.
            
            // **ì¤‘ìš”**: í˜„ì¬ëŠ” ì‚¬ì´íŠ¸ êµ¬ì¡°ë¥¼ ëª¨ë¥´ë‹ˆ, ì‚¬ìš©ìì—ê²Œ ìˆ˜ë™ ì…ë ¥ì„ ìš”ì²­í•˜ê±°ë‚˜ 
            // ê°€ì ¸ì˜¨ í…ìŠ¤íŠ¸ë¥¼ ë³´ì—¬ì£¼ëŠ” ë°©ì‹ìœ¼ë¡œ ê°ˆ ìˆ˜ë„ ìˆìŠµë‹ˆë‹¤.
            // ì¼ë‹¨ì€ 'ê°€ì ¸ì˜¤ê¸° ì„±ê³µ' ê¹Œì§€ë§Œ êµ¬í˜„í•˜ê³ , í˜ì´ì§€ í…ìŠ¤íŠ¸ ì „ì²´ì—ì„œ "ë¶„" ì•ì˜ ìˆ«ìë¥¼ ì°¾ì•„ë´…ë‹ˆë‹¤.
            
            const bodyText = doc.body.innerText || "";
            // ì˜ˆ: "ì´ ì‚¬ìš©ì‹œê°„ : 1200ë¶„" ê°™ì€ íŒ¨í„´ì„ ì°¾ìŒ
            const match = bodyText.match(/([0-9,]+)\s*ë¶„/); 
            
            let usedMinutes = 0;
            if (match) {
                usedMinutes = parseInt(match[1].replace(/,/g, ''));
                status.innerText = "ë°ì´í„° ì—…ë°ì´íŠ¸ ì™„ë£Œ!";
                status.className = "status-msg status-success";
            } else {
                // ìˆ«ìë¥¼ ëª» ì°¾ì•˜ì„ ê²½ìš°
                status.innerText = "ì‚¬ì´íŠ¸ ì ‘ì†ì€ ì„±ê³µí–ˆìœ¼ë‚˜, ì‹œê°„ ì •ë³´ë¥¼ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                status.className = "status-msg status-error";
                // ë””ë²„ê¹…ì„ ìœ„í•´ ë‚´ìš©ì„ ì½˜ì†”ì— ì¶œë ¥
                console.log("Fetched HTML:", data.contents);
                
                // ì„ì‹œ: 0ìœ¼ë¡œ ì„¤ì •í•˜ê³  ê³„ì‚° ë¡œì§ë§Œ ë³´ì—¬ì¤Œ
                usedMinutes = 0; 
                alert("ìë™ ì¸ì‹ ì‹¤íŒ¨: í˜ì´ì§€ êµ¬ì¡°ê°€ ì˜ˆìƒê³¼ ë‹¤ë¦…ë‹ˆë‹¤.\n(ê°œë°œì ë„êµ¬ Consoleì—ì„œ ê°€ì ¸ì˜¨ HTMLì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤)");
            }

            // 4. ê²°ê³¼ ê³„ì‚° ë° í‘œì‹œ
            calculate(usedMinutes);

        } catch (error) {
            console.error(error);
            status.innerText = "ì ‘ì† ì‹¤íŒ¨: íšŒì‚¬ ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì°¨ë‹¨ë˜ì—ˆê±°ë‚˜ ì„œë²„ ì˜¤ë¥˜ì…ë‹ˆë‹¤.";
            status.className = "status-msg status-error";
        } finally {
            btn.disabled = false;
            btn.innerText = "ë°ì´í„° ê°€ì ¸ì˜¤ê¸° & ë¶„ì„";
        }
    }

    function calculate(used) {
        const remain = MAX_MINUTES - used;
        const daysLeft = (remain / DAILY_MAX).toFixed(1);

        document.getElementById('usedTime').innerText = `${used}ë¶„`;
        document.getElementById('remainTime').innerText = `${remain}ë¶„`;
        document.getElementById('remainDays').innerText = `${daysLeft}ì¼`;
        
        // ìƒ‰ìƒ ì²˜ë¦¬
        const remainEl = document.getElementById('remainTime');
        if(remain < 0) {
            remainEl.className = "result-value warning";
            remainEl.innerText = `${remain}ë¶„ (ì´ˆê³¼)`;
        } else {
            remainEl.className = "result-value highlight";
        }

        document.getElementById('resultBox').style.display = 'block';
    }
</script>

</body>
</html>
